# koa 快速入门

## koa2 简介

- 基于 Node.js 平台的 web 开发框架
- 有 Express 原班人马打造

  - express 使用回调函数处理异步,可能会导致回调函数嵌套过多的问题

  - 为了解决这个问题 所以出现了 koa = > Generator+yield 的方法解决异步回调

  - node v7.6 版本出现的 async/await 是处理异步函数最优雅的方式,所以出现了 koa2

## koa2 特点

- 支持 async/await

- 支持洋葱模型的中间件

      如下图所示, 对于服务器而言，它其实就是来处理一个又一个的请求， Web 服务器接收由浏览器发过来的一个又一个请求之后，它形成一个又一个的响应返回给浏览器.  而请求到达我们的服务器是需要经过程序处理的,程序处理完之后才会形成响应，返回给浏览器，我们服务器处理请求的这一  块程序，在Koa2 的世界当中就把它称之为中间件

      |      |                                                              |

  | ---- | ------------------------------------------------------------ |
  | | ![img](file:///C:\Users\ADMINI~1\AppData\Local\Temp\ksohtml1800\wps3.png) |

      这种中间件可能还不仅仅只有一个，可能会存在多个，比如上图所示,  它就存在三层中间件，这三层中间件在处理请求的过程以及它调用的顺序为:

  - 当一个请求到达咱们的服务器，最先最先处理这个请求的是第一层中间件第一层的中间件在处理这个请求之后，它会把这个请求给第二层的中间件第二层的中间件在处理这个请求之后，它会把这个请求给第三层的中间件

  - 第三层中间件内部并没有中间件了, 所以第三层中间件在处理完所有的代码之后，这个请求又会到了第二层的中间件，所以第二层中间件对这个请求经过了两次的处处理

  - 第二层的中间件在处理完这个请求之后，又到了第一层的中间件, 所以第一层的中间件也对这个请求经过了两次的处理

    这个调用顺序就是洋葱模型, 中间件对请求的处理有一种先进后出的感觉，请求最先到达第一层中间件，而最后也是第一层中间件对请求再次处理了一下

## 快速上手

- 检查 Node 的环境

```
node -v
```

- 安装 koa

```
npm init -y
npm i koa
```

- 创建并编写 app.js 文件

```js
// 1.创建koa对象
const Koa = require('koa'); // 导入构造方法
const app = new Koa(); // 通过构造方法, 创建实例对象
```

- 编写响应函数(中间件)

```js
// 响应函数是通过use的方式才能产生效果, 这个函数有两个参数, 一个是ctx ,一个是next
// ctx: 上下文, 指的是请求所处于的Web容器,我们可以通过ctx.request 拿到请求对象, 也可以通过ctx.response 拿到响应对象
// next: 内层中间件执行的入口
// 2.编写响应函数(中间件)
app.use((ctx, next) => {
	console.log(ctx.request.url) ctx.response.body = 'hello world'
})
```

- 监听一个端口号

```
通过app.listen 就可以指明一个端口号
```

- 启动服务器

```js
node app.js
// or
nodemon app.js
```

## koa2 中间件的特点

- koa2 的实例对象通过`use`方法加入一个中间件

- 一个中间件就是一个函数 这个函数具备两个参数, 分别是`ctx`和`next`

- 中间件的执行符合洋葱模型

- 内层中间件能否执行取决于外层中间件的`next`函数是否调用

- 调用`next`函数得到的是`promise`对象,如果想得到`promise`所包含的数据,可以结合`await`和`async`

```js
app.use(async (ctx, next) => {
  // 刚进入中间件想做的事
  await next();
  // 内层所有中间件结束之后想做的事情
});
```
